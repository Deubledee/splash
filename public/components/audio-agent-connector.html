<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="stylesheet" href="audio-input-source.html">
<dom-module id="audio-agent-connector">
    <template>
        <style include="shared-styles-dropdown">
            :host {
                width: 100%;
                flex-basis: 187px;
            }

            a {
                color: black;
                text-decoration: none;
            }

            nav {
                /* box-shadow: 2px 2px 6px #272424; */
                border-radius: var(--app-standart-border-radius);
                width: 90%;
                height: 182px;
                background-color: var(--app-secondary-background-color);
                color: var(--app-color);
            }

            article {
                display: flex;
                flex-flow: column;
                border-radius: var(--app-standart-border-radius);
                padding: var(--app-standart-border-radius);
            }

            article label[for=connector] {
                font-family: 'NotoColorEmoji';
                font-size: 21px;
                margin-bottom: var(--app-standart-border-radius);
                width: 100%;
                text-shadow: var(--app-type-dropdown-text-shadow);
                padding-left: 9px;
                padding-top: 3px;
                background-color: var(--app-primary-background-color);
                border-radius: var(--app-standart-border-radius)
            }

            section {
                display: flex;

            }

            aside {
                flex-basis: 71px
            }

            paper-listbox.dropdown-content {
                background-color: var(--paper-grey-50);
            }

            paper-item[sellected] {
                background-color: var(--app-type-sellected-background-color)
            }

            paper-dropdown-menu.custom2 {
                --paper-input-container-underline: {
                    display: initial;
                }
            }
        </style>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}" query-params="{{query}}"></app-route>
        <nav>
            <article>
                <section>
                    <label for="connector">
                        <span> [[permanentType]] [[type]] </span>
                    </label>
                </section>
                <aside>
                    <paper-dropdown-menu class="custom custom2" label="[[value]]">
                        <paper-listbox id="listBox1" slot="dropdown-content" class="dropdown-content" selected="0">
                            <template is="dom-repeat" items="{{options}}" as="option" mutable-data="true">
                                <paper-item on-click="connection" id="[[option.id]]" value=[[option.name]]>
                                    [[option.name]]
                                </paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </aside>
                <aside>
                    <paper-dropdown-menu class="custom custom2" label="[[value2]]">
                        <paper-listbox id="listBox2" slot="dropdown-content" class="dropdown-content" selected="0">
                            <template is="dom-repeat" items="{{destinations}}" as="destination" mutable-data="true">
                                <paper-item on-click="destination" id="[[destination.id]]" value="[[destination.name]]">
                                    [[destination.name]]
                                </paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </aside>
            </article>
        </nav>
    </template>
    <script>

        class audioAgentConnector extends Polymer.Element {
            static get is() {
                return 'audio-agent-connector';
            }
            constructor() {
                super();
            }
            ready() {
                super.ready()
                window.addEventListener('elemem-title', (event) => {
                    this.ocupied = false
                    setTimeout(() => {
                        this.title(event.detail.title)
                        this._elemTitleChanged()
                        this._elemDestinationChanged()
                    }, 100)
                })
                window.addEventListener('remove-elem', (event) => {
                    if (this.permanentType === event.detail.title) {
                        this.removeCall()
                    }
                    this._elemTitleChanged()
                }, false)
            }
            static get properties() {
                return {
                    type: {
                        type: String
                    },
                    permanentType: {
                        type: String,
                    },
                    agentClass: {
                        type: Object,
                        notify: true
                    },
                    value: {
                        type: String,
                        value: 'Connect to',
                        notify: true,
                    },
                    value2: {
                        type: String,
                        value: 'Destinations',
                        notify: true,
                    },
                    temp: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },
                    options: {
                        type: Array,
                        value: [{ name: 'Connections' }],
                        notify: true
                    }
                }
            }

            _elemDestinationChanged() {
                setTimeout(() => {
                    let keys = Object.keys(this.agentClass.streamNode)
                    let arr = [{ id: 'Destinations', name: 'Destinations' },
                    { id: 'speakers', name: 'speakers' }]
                    this.destinations = []
                    if (keys.length > 0) {
                        for (let node in this.agentClass.streamNode) {
                            if (node !== this.permanentType)
                                arr.push({ id: node, name: node })
                        }
                    }
                    this.destinations = arr
                }, 500)
            }

            _elemTitleChanged(data) {
                setTimeout(() => {
                    // console.log(this.agentClass.contextNode)
                    let arr = [{ id: 'Connections', name: 'Connections' }]
                    this.options = []
                    for (let node in this.agentClass.contextNode) {
                        if (node !== this.permanentType)
                            arr.push({ id: node, name: node })
                    }
                    this.options = arr
                }, 500)
            }

            removeCall(data) {
                if (this.type !== 'source') {
                    if (this.agentClass.contextNode[this.permanentType].connected) {
                        this.agentClass.connectAgents((err) => {
                            if (err)
                                throw this.error('disconnection', err)
                        }, this.agentClass.contextNode[this.permanentType].connected, this.agentClass.contextNode[this.permanentType], false)
                    }
                }
                this.parentElement.removeChild(this)
                delete this.agentClass.contextNode[this.permanentType]
            }

            title(elemTitle) {
                if (!this.permanentType) {
                    this.permanentType = elemTitle
                } /*else {
                    return this.permanentType
                }*/
            }

            connection(data) {
                if (data && data.model && data.model.__data.option.name !== 'Connections') {
                    let dest = this.type === 'source' ? this.agentClass.sourceNode : this.agentClass.contextNode
                    let bool = data.model.children[1].hasAttribute('sellected') === true ? false : true
                    this.agentClass.connectAgents((err) => {
                        if (err) {
                            throw this.error('connection', err)
                        } else {
                            if (bool === true) {
                                data.model.children[1].setAttribute('sellected', true)
                            }
                            if (bool === false) {
                                data.model.children[1].removeAttribute('sellected', true)
                            }
                        }
                    }, dest[this.permanentType], this.agentClass.contextNode[data.model.__data.option.name], bool)
                    this.changeToOne(this.$.listBox1.__data.items[0])
                }
            }

            destination(data) {
                console.log(this.$.listBox2.__data.items[0])
                if (data && data.model && data.model.__data.destination.name !== 'Destinations') {
                    let dest = this.type === 'source' ? this.agentClass.sourceNode : this.agentClass.contextNode
                    let destination = data.model.__data.destination.name === 'speakers' ? this.agentClass.context.destination :
                        this.agentClass.streamNode[data.model.__data.destination.name]
                    let bool = data.model.children[1].hasAttribute('sellected') === true ? false : true
                    this.agentClass.connectAgents((err) => {
                        if (err) {
                            throw this.error('destination', err)
                        } else {
                            if (bool === true) {
                                data.model.children[1].setAttribute('sellected', true)
                            }
                            if (bool === false) {
                                data.model.children[1].removeAttribute('sellected', true)
                            }
                        }
                    }, dest[this.permanentType], destination, bool)
                    this.changeToOne(this.$.listBox2.__data.items[0])
                }
            }

            error(msg, err) {
                console.error(msg, err);
            }

            changeToOne(data) {
                setTimeout(() => {
                    data.click()
                }, 100)
            }
        }
        window.customElements.define(audioAgentConnector.is, audioAgentConnector);

    </script>
</dom-module>